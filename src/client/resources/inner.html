<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <style type="text/css">
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="container" style="width: 100%; height: 100%;"></div>
    <script src="https://unpkg.com/monaco-editor@0.8.3/min/vs/loader.js"></script>
    <script>
        require.config({
            paths: {
                vs: "https://unpkg.com/monaco-editor@0.8.3/min/vs",
            },
        });
        window.MonacoEnvironment = {
            getWorkerUrl: () => proxy,
        };

        let proxy = URL.createObjectURL(
            new Blob([
                `
	self.MonacoEnvironment = {
		baseUrl: 'https://unpkg.com/monaco-editor@0.8.3/min/'
	};
	importScripts('https://unpkg.com/monaco-editor@0.8.3/min/vs/base/worker/workerMain.js');
`,
            ])
        );
        let monacoEditor;
        let editor;
        require(["vs/editor/editor.main"], function() {
            monacoEditor = monaco;
            editor = monaco.editor.create(document.getElementById("container"), {
                value: ["function x() {", '\tconsole.log("Hello world!");', "}"].join(
                    "\n"
                ),
                language: "javascript",
                theme: "vs-light",
            });

            editor.addListener("didType", () => {
                let content = `${editor.getValue()}`;
                sendFileChanged(content);
            });
        });

        function setContent(obj) {
            editor.setValue(obj.content);
        }

        // addEventListener support for IE8
        function bindEvent(element, eventName, eventHandler) {
            if (element.addEventListener) {
                element.addEventListener(eventName, eventHandler, false);
            } else if (element.attachEvent) {
                element.attachEvent("on" + eventName, eventHandler);
            }
        }

        /*************************************************************************************/
        /*Communications*/
        // Listen to messages from parent window
        let fileId;
        bindEvent(window, "message", function(e) {
            let data = e.data;
            try {
                let fileObj = JSON.parse(e.data);
                if (fileObj && fileObj.lwclink) {
                    setLanguage(fileObj.fileName);
                    editor.setValue(fileObj.fileContent);
                    fileId = fileObj.id;
                }
            } catch (e) {}
        });
        var sendMessage = function(msg) {
            // Make sure you are sending a string, and to stringify JSON
            window.parent.postMessage(msg, "*");
        };

        function sendFileChanged(content) {
            let obj = {
                content: content,
                lwclink: true,
                fileId: fileId
            };
            sendMessage(JSON.stringify(obj));
        }
        /*************************************************************************************/
        function setLanguage(filename) {
            if (filename) {
                const languages = {
                    js: "javascript",
                    ts: "typescript",
                    html: "html",
                    htm: "html",
                    txt: "text",
                    css: "css",
                };
                const ext = filename.match(/([^\.])+$/g)[0];
                monacoEditor.editor.setModelLanguage(
                    monacoEditor.editor.getModels()[0],
                    languages[ext]
                );
            }
        }
    </script>
</body>

</html>